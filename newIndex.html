<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Mesajlaşma</title>

        <link rel="stylesheet" href="https://bootswatch.com/3/darkly/bootstrap.min.css" type="text/css">

        <style type="text/css">
            .panel-body strong{
            color: #375a7f;
            }

            .panel-title{
                display: inline-block;
            }
            .panel-title-right{
                float: right;
                font-size: 17px;
                margin-top: 0;
                margin-bottom: 0;
                font-size: 17px;
                color: inherit;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-md-8 col-md-offset-2" style="padding-top: 20px;">
                    <center>
                            <h3>ORTAK ODA</h3>
                            <p class="lead">Herkesin olduğu yer</p>
                    </center>
                     
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <h3 class="panel-title">Chat</h3><h3 class="panel-title-right">Çevrimiçi: 1</h3>
                        </div>
                        <div class="panel-body pre-scrollable mesajlar" style="height:350px;">
                            
                        </div>
                        <div class="panel-footer">
                            <input class="form-control mesajText" onkeypress="yazildi()" rows="2" placeholder="Bir şeyler yaz..." autofocus>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
        <script src="https://bootswatch.com/3/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

        <script type="text/javascript">

        var socket = io.connect();
        //var isim = prompt("Lütfen isminizi giriniz");
        //socket.emit("gonder", isim);
        /*
        socket.on("al", function(veri)
        {
            if (veri != isim)
            {
                alert(veri + "sisteme giriş yaptı.");
            }
        })
        */
       var isim = "";
       $(document).ready(function(){
        $('#loginModal').modal({
            backdrop: 'static',
            show: "true",
            keyboard: false
        });
       });

       function login()
       {
           var tus = window.event.keyCode;
           if( tus == 13 )
           {
               var username = $("#username").val();
            
               if( username == '' )
               {
                    $("#errUsername").show();
               }
               else
               {
                    socket.emit("gonder", username);
                    
                    socket.on("al", function(veri)

                    {
                        if (veri != username)
                        {
                          $( ".panel-title" ).text(veri + " sisteme giriş yaptı.");                        }
                    })


                    $("#loginModal").modal("hide");
                    isim = username;
               }
           }
       }
       



        function yazildi(){
        var tus = window.event.keyCode;
        if (tus == 13)
        {
            // var metin = document.getElementById('mesaj').value;
            var metin =  $(".mesajText").val();
            if( metin ==  '' )
            {
                alert("sa");
                exit;
            }
            socket.emit("mesaj", {"mesaj":metin,"kullanici":isim});

            $(".mesajText").val("");
            // document.getElementById('mesaj').value = "";
        }
    }

    socket.on("mesajAl", function(veri)
    {
        $(".mesajlar").append('<div class="panel panel-default"><div class="panel-body"><strong>'+veri.kullanici+': </strong> '+veri.mesaj+'</div></div>');
        $(".pre-scrollable").scrollTop($(".pre-scrollable").get(0).scrollHeight);
        // $('.mesajlar').append($('').text(veri.kullanici + ": " + veri.mesaj));
    });


    socket.on("alsayi" ,function(sayi)
    {
    $(".panel-title-right").text("Çevrimiçi: " + sayi);
    console.log(sayi)
    });

    
    </script>


        <div class="modal" id="loginModal" class="display:none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Giriş Yap</h4>
                    </div>
                    <div class="modal-body">
                        <p>Devam etmeden önce giriş yapmalısınız</p>
                        <p id="errUsername" style="display:none;color:red;">Geçerli bir kullanıcı adı girmelisiniz.</p>
                        <input type="text" autofocus onkeypress="login()" id="username" class="form-control">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>